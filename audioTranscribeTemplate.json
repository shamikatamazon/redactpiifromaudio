{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Transform": "AWS::Serverless-2016-10-31",
	"Parameters": {
		"SourceS3": {
			"Type": "String",
			"Default": "redactaudiosource",
			"Description": "The source bucket for unredacted content"
		},
		"TargetS3": {
			"Type": "String",
			"Default": "redactaudiotarget",
			"Description": "The target bucket for redacted content"
		},
		"ConversionTargetS3": {
			"Type": "String",
			"Default": "conversiong729output1",
			"Description": "The target bucket for converted content"
		},
		"ConversionSourceS3": {
			"Type": "String",
			"Default": "conversiong729input1",
			"Description": "The target bucket for converted content"
		}
	},
	"Resources": {
		"OutputS3Bucket": {
			"Type": "AWS::S3::Bucket",
			"Properties": {
				"BucketName": {
					"Ref": "TargetS3"
				},
				"OwnershipControls": {
					"Rules": [{
						"ObjectOwnership": "BucketOwnerEnforced"
					}]
				}
			}
		},
		"ConversionOutputS3Bucket": {
			"Type": "AWS::S3::Bucket",
			"Properties": {
				"BucketName": {
					"Ref": "ConversionTargetS3"
				},
				"OwnershipControls": {
					"Rules": [{
						"ObjectOwnership": "BucketOwnerEnforced"
					}]
				}
			}
		},
		"InputS3Bucket": {
			"Type": "AWS::S3::Bucket",
			"Properties": {
				"BucketName": {
					"Ref": "SourceS3"
				},
				"OwnershipControls": {
					"Rules": [{
						"ObjectOwnership": "BucketOwnerEnforced"
					}]
				},
				"NotificationConfiguration": {
					"LambdaConfigurations": [{
						"Event": "s3:ObjectCreated:*",
						"Function": {
							"Fn::GetAtt": ["TranscribeFunction", "Arn"]
						}
					}]
				}
			}
		},
		"InputBucketS3Permission": {
			"Type": "AWS::Lambda::Permission",
			"Properties": {
				"Action": "lambda:InvokeFunction",
				"FunctionName": {
					"Ref": "TranscribeFunction"
				},
				"Principal": "s3.amazonaws.com",
				"SourceAccount": {
					"Ref": "AWS::AccountId"
				},
				"SourceArn": {
					"Fn::GetAtt": ["InputS3Bucket", "Arn"]
				}
			}

		},
		"ConversationInputBucketS3Permission": {
			"Type": "AWS::Lambda::Permission",
			"Properties": {
				"Action": "lambda:InvokeFunction",
				"FunctionName": {
					"Ref": "g729ConvertFunction"
				},
				"Principal": "s3.amazonaws.com",
				"SourceAccount": {
					"Ref": "AWS::AccountId"
				},
				"SourceArn": {
					"Fn::GetAtt": ["ConversionInputS3Bucket", "Arn"]
				}
			}

		},
		"ConversionInputS3Bucket": {
			"Type": "AWS::S3::Bucket",
			"Properties": {
				"BucketName": {
					"Ref": "ConversionSourceS3"
				},
				"OwnershipControls": {
					"Rules": [{
						"ObjectOwnership": "BucketOwnerEnforced"
					}]
				},
				"NotificationConfiguration": {
					"LambdaConfigurations": [{
						"Event": "s3:ObjectCreated:*",
						"Function": {
							"Fn::GetAtt": ["g729ConvertFunction", "Arn"]
						}
					}]
				}
			}
		},
		"TranscribeFunction": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Timeout": 900,
				"FunctionName": "triggerTranscribe",
				"Handler": "index.handler",
				"Role": {
					"Fn::GetAtt": ["TranscribeLambdaRole", "Arn"]
				},
				"Code": {
					"S3Bucket": "transcribelambdacode",
					"S3Key": "TranscribeFunctionCode"
				},
				"Runtime": "python3.9",
				"MemorySize": 10240,
				"Environment": {
					"Variables": {
						"sourceS3": {
							"Ref": "SourceS3"
						},
						"targetS3": {
							"Ref": "TargetS3"
						}
					}
				},
				"Layers": [{
					"Ref": "ffmpeglib"
				}]
			}
		},
		"ffmpeglib": {
			"Type": "AWS::Serverless::LayerVersion",
			"Properties": {
				"LayerName": "ffmpegLayer",
				"ContentUri": "s3://transcribelambdacode/ffmpeg.zip",
				"CompatibleRuntimes": [
					"python3.9"
				]
			}
		},
		"TranscribeLambdaRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"RoleName": "TranscribeLambdaRole",
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": ["lambda.amazonaws.com"]
						},
						"Action": ["sts:AssumeRole"]
					}]
				},
				"Path": "/",
				"Policies": [{
						"PolicyName": "AWSLambdaBasicExecutionRole",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [{
								"Effect": "Allow",
								"Action": [
									"logs:CreateLogGroup",
									"logs:CreateLogStream",
									"logs:PutLogEvents"
								],
								"Resource": "*"
							}]
						}
					},
					{
						"PolicyName": "AmazonS3FullAccess",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [{
								"Effect": "Allow",
								"Action": "s3:*",
								"Resource": [
									"arn:aws:s3:::*"
								]
							}]
						}
					},
					{
						"PolicyName": "AmazonTranscribeFullAccess",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [{
								"Effect": "Allow",
								"Action": "transcribe:*",
								"Resource": "*"
							}]
						}
					}
				]
			}
		},
		"g729ConvertFunction": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Timeout": 900,
				"FunctionName": "convertg729AndTranscribe",
				"Handler": "index.handler",
				"Role": {
					"Fn::GetAtt": ["TranscribeLambdaRole", "Arn"]
				},
				"Code": {
					"S3Bucket": "transcribelambdacode",
					"S3Key": "g729convertLambdaCode"
				},
				"Runtime": "python3.9",
				"MemorySize": 10240,
				"Environment": {
					"Variables": {
						"targetS3": {
							"Ref": "ConversionTargetS3"
						}
					}
				},
				"Layers": [{
					"Ref": "ffmpeglib"
				}]
			}
		}
	}
}